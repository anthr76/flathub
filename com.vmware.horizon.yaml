---
app-id: com.vmware.horizon
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: vmware-view
finish-args:
  - "--share=ipc"
  - "--device=dri"
  - "--socket=x11"
  - "--share=network"
  - "--env=LD_LIBRARY_PATH=/app/lib:/app/lib/vmware"
  - "--env=GDK_BACKEND=x11"
  - "--env=ENABLE_FOLDER_REDIRECTION=true"
  - "--persist=.vmware"
build-options:
  env:
    VERSION: 2106-8.3.0-18251983
modules:
  - name: glib
    buildsystem: meson
    sources:
      - type: archive
        url: https://download.gnome.org/sources/glib/2.69/glib-2.69.1.tar.xz
        sha256: f92f34057a091fc8638d91f10cece842cb8618e9a1090b0ddb19cc15a21bf39c
  - name: xprop
    sources:
      - type: archive
        url: https://xorg.freedesktop.org/releases/individual/app/xprop-1.2.4.tar.bz2
        sha256: 8c77fb096e46c60032b7e2bde9492c3ffcc18734f50b395085a5f10bfd3cf753
  - name: libusb
    config-opts:
      - "--disable-static"
    cleanup:
      - "/lib/*.la"
      - "/lib/pkgconfig"
      - "/include"
    sources:
      - type: git
        url: https://github.com/libusb/libusb.git
        tag: "v1.0.23"
        commit: e782eeb2514266f6738e242cdcb18e3ae1ed06fa
  - name: pcsc
    config-opts:
      - "--disable-libsystemd"
      - "--enable-pic"
      - "--disable-libusb"
      - "--enable-shared"
      - "--with-systemdsystemunitdir=/app/lib/systemd/"
    sources:
      - type: git
        url: https://github.com/LudovicRousseau/PCSC.git
        tag: "pcsc-1.9.0"
        commit: e796a0f12fbefa459bff0d25e27089615fa91f21
  - name: freerdp
    buildsystem: cmake-ninja
    cleanup: []
    config-opts:
      - "-DCMAKE_BUILD_TYPE:STRING=Release"
      - "-DCMAKE_INSTALL_LIBDIR:PATH=lib"
      - "-DWITH_WAYLAND:BOOL=ON"
      - "-DCHANNEL_TSMF:BOOL=ON"
      - "-DCHANNEL_URBDRC:BOOL=OFF"
      - "-DBUILD_TESTING:BOOL=OFF"
      - "-DWITH_MANPAGES:BOOL=OFF"
      - "-DWITH_GSSAPI:BOOL=OFF"
      - "-DWITH_PCSC:BOOL=OFF"
      - "-DWITH_SERVER:BOOL=OFF"
      - "-DWITH_CUPS:BOOL=ON"
      - "-DWITH_FFMPEG:BOOL=ON"
      - "-DWITH_OSS:BOOL=OFF"
      - "-DWITH_PULSE:BOOL=ON"
      - "-DWITH_CHANNELS:BOOL=ON"
      - "-DWITH_LIBSYSTEMD:BOOL=OFF"
      - "-DWITH_WAYLAND:BOOL=OFF"
    sources:
      - type: git
        url: https://github.com/FreeRDP/FreeRDP.git
        tag: 2.4.0
        commit: f797e200a2cd47fd42318359b8ae4d46e6507eec
  - name: vmware-horizon-client
    buildsystem: simple
    sources:
      - type: archive
        url: https://download3.vmware.com/software/view/viewclients/CART22FQ2/VMware-Horizon-Client-Linux-2106-8.3.0-18251983.tar.gz
        sha256: 368d0b08c1d5be109ab70f692fe9809377f7cf7c20a46bbf72eedf73e59f1035
      - type: file
        path: com.vmware.horizon.metainfo.xml
    build-commands:
      - tar xzvf x64/VMware-Horizon-Client-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-Client-Linux-ClientSDK-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-html5mmr-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-integratedPrinting-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-PCoIP-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-scannerClient-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-serialportClient-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-TeamsOptimization-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-USB-${VERSION}.x64.tar.gz
      - tar xzvf x64/VMware-Horizon-USB-sdk-${VERSION}.x64.tar.gz
      - find ./ -name '*.so*' -exec chmod 755 {} +
      - mkdir -p ${FLATPAK_DEST}/lib/vmware/
      - find ./ -name '*.so*' -exec cp -v -n -t ${FLATPAK_DEST}/lib/vmware/ {} +
      - ln -sf /usr/lib/x86_64-linux-gnu/libudev.so.1 "${FLATPAK_DEST}/lib/libudev.so.0"
      - cp -a VMware-Horizon-Client-${VERSION}.x64/lib/vmware/view/bin "${FLATPAK_DEST}"
      - install -Dm644 VMware-Horizon-Client-${VERSION}.x64/share/applications/vmware-view.desktop ${FLATPAK_DEST}/share/applications/com.vmware.horizon.desktop
      - desktop-file-edit --remove-key=Exec ${FLATPAK_DEST}/share/applications/com.vmware.horizon.desktop
      - desktop-file-edit --set-key=Exec --set-value='/app/bin/vmware-view %u' ${FLATPAK_DEST}/share/applications/com.vmware.horizon.desktop
      - desktop-file-edit --remove-key=Icon ${FLATPAK_DEST}/share/applications/com.vmware.horizon.desktop
      - install -Dm644 VMware-Horizon-Client-${VERSION}.x64/share/icons/vmware-view.png ${FLATPAK_DEST}/share/icons/com.vmware.horizon.png
      - desktop-file-edit --set-key=Icon --set-value='com.vmware.horizon' ${FLATPAK_DEST}/share/applications/com.vmware.horizon.desktop
      - install -Dm 644 -t /app/share/metainfo com.vmware.horizon.metainfo.xml
      - sed -i 's/\/usr\/lib\/vmware\/%s/\/app\/lib\/vmware\/%s/g' /app/bin/vmware-view
